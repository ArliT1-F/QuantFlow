<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantFlow Paper Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .positive {
            color: #27ae60;
        }
        .negative {
            color: #e74c3c;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running {
            background-color: #27ae60;
        }
        .status-stopped {
            background-color: #e74c3c;
        }
        .status-starting {
            background-color: #f39c12;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-custom {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
        }
        .sidebar {
            background: #f8f9fa;
            min-height: 100vh;
            padding: 1rem;
        }
        .nav-link {
            color: #495057;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }
        .nav-link.active {
            background-color: #007bff;
            color: white;
        }
        .nav-link:hover {
            background-color: #e9ecef;
        }
        .content-area {
            padding: 1rem;
        }
        .alert-custom {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <h4 class="mb-4"><i class="fas fa-robot"></i> <span data-i18n="sidebar_title">Trading Bot</span></h4>
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" onclick="showSection('dashboard', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Overview of system status">
                        <i class="fas fa-tachometer-alt"></i> <span data-i18n="nav_dashboard">Dashboard</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('portfolio', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Portfolio summary and metrics">
                        <i class="fas fa-briefcase"></i> <span data-i18n="nav_portfolio">Portfolio</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('positions', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Open positions and P&L">
                        <i class="fas fa-chart-line"></i> <span data-i18n="nav_positions">Positions</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('trades', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Trade history and fills">
                        <i class="fas fa-exchange-alt"></i> <span data-i18n="nav_trades">Trades</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('strategies', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Strategy status and performance">
                        <i class="fas fa-cogs"></i> <span data-i18n="nav_strategies">Strategies</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('backtest', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Run historical simulations">
                        <i class="fas fa-flask"></i> <span data-i18n="nav_backtest">Backtest</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('risk', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Risk limits and daily metrics">
                        <i class="fas fa-shield-alt"></i> <span data-i18n="nav_risk">Risk Management</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('market', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Latest market prices">
                        <i class="fas fa-chart-bar"></i> <span data-i18n="nav_market">Market Data</span>
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('settings', this); return false;" data-bs-toggle="tooltip" data-bs-placement="right" title="Configuration and notifications">
                        <i class="fas fa-cog"></i> <span data-i18n="nav_settings">Settings</span>
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 content-area">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section">
                    <div class="dashboard-header">
                        <div class="container">
                            <div class="d-flex align-items-center justify-content-between flex-wrap">
                                <div>
                                    <h1><i class="fas fa-robot"></i> <span data-i18n="app_title">QuantFlow Paper Trading</span></h1>
                                    <p class="lead mb-0" data-i18n="app_subtitle">Real-time monitoring and control of your automated trading system</p>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <div id="venue-chip" class="badge bg-secondary fs-6 px-3 py-2"></div>
                                    <select id="language-select" class="form-select form-select-sm" style="width: 150px;">
                                        <option value="en">English</option>
                                        <option value="sq">Shqip</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-label" data-i18n="trading_status">Trading Status</div>
                                        <div class="metric-value" id="trading-status">
                                            <span class="status-indicator status-stopped"></span>Stopped
                                        </div>
                                    </div>
                                    <i class="fas fa-power-off fa-2x text-muted"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-label" data-i18n="portfolio_value">Portfolio Value</div>
                                        <div class="metric-value" id="portfolio-value">$0.00</div>
                                    </div>
                                    <i class="fas fa-dollar-sign fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-label" data-i18n="total_pnl">Total P&amp;L</div>
                                        <div class="metric-value" id="total-pnl">$0.00</div>
                                    </div>
                                    <i class="fas fa-chart-line fa-2x text-info"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="metric-label" data-i18n="active_positions">Active Positions</div>
                                        <div class="metric-value" id="active-positions">0</div>
                                    </div>
                                    <i class="fas fa-briefcase fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="metric-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" data-i18n="recent_events">Recent Signals &amp; Events</h5>
                                    <span class="text-muted" id="events-count"></span>
                                </div>
                                <div class="table-responsive mt-2">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th data-i18n="time">Time</th>
                                                <th data-i18n="type">Type</th>
                                                <th data-i18n="symbol">Symbol</th>
                                                <th data-i18n="strategy">Strategy</th>
                                                <th data-i18n="message">Message</th>
                                            </tr>
                                        </thead>
                                        <tbody id="events-table">
                                            <tr><td colspan="5" class="text-muted text-center">No events yet</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-custom" onclick="startTrading()" data-bs-toggle="tooltip" data-bs-placement="top" title="Start the trading engine">
                                    <i class="fas fa-play"></i> <span data-i18n="start_trading">Start Trading</span>
                                </button>
                                <button class="btn btn-danger btn-custom" onclick="stopTrading()" data-bs-toggle="tooltip" data-bs-placement="top" title="Stop the trading engine">
                                    <i class="fas fa-stop"></i> <span data-i18n="stop_trading">Stop Trading</span>
                                </button>
                                <button class="btn btn-info btn-custom" onclick="refreshData()" data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh dashboard data">
                                    <i class="fas fa-sync"></i> <span data-i18n="refresh_data">Refresh Data</span>
                                </button>
                                <button class="btn btn-warning btn-custom" onclick="testNotification()" data-bs-toggle="tooltip" data-bs-placement="top" title="Send a test notification">
                                    <i class="fas fa-bell"></i> <span data-i18n="test_alert">Test Alert</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5><i class="fas fa-chart-line"></i> <span data-i18n="portfolio_performance">Portfolio Performance</span></h5>
                                <div class="chart-container">
                                    <canvas id="portfolioChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5><i class="fas fa-chart-pie"></i> <span data-i18n="position_distribution">Position Distribution</span></h5>
                                <div class="chart-container">
                                    <canvas id="positionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Trades -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="metric-card">
                                <h5><i class="fas fa-history"></i> <span data-i18n="recent_trades">Recent Trades</span></h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th data-i18n="time">Time</th>
                                                <th data-i18n="symbol">Symbol</th>
                                                <th data-i18n="action">Action</th>
                                                <th data-i18n="quantity">Quantity</th>
                                                <th data-i18n="price">Price</th>
                                                <th data-i18n="strategy">Strategy</th>
                                                <th data-i18n="status">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-trades">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">No recent trades</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Section -->
                <div id="portfolio-section" class="content-section" style="display: none;">
                    <h2><i class="fas fa-briefcase"></i> <span data-i18n="portfolio_overview">Portfolio Overview</span></h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5 data-i18n="performance_metrics">Performance Metrics</h5>
                                <div id="portfolio-metrics">
                                    <p class="text-muted">Loading portfolio metrics...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5 data-i18n="risk_metrics">Risk Metrics</h5>
                                <div id="risk-metrics">
                                    <p class="text-muted">Loading risk metrics...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Positions Section -->
                <div id="positions-section" class="content-section" style="display: none;">
                    <h2><i class="fas fa-chart-line"></i> <span data-i18n="active_positions_title">Active Positions</span></h2>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th data-i18n="symbol">Symbol</th>
                                    <th data-i18n="quantity">Quantity</th>
                                    <th data-i18n="avg_price">Avg Price</th>
                                    <th data-i18n="current_price">Current Price</th>
                                    <th data-i18n="unrealized_pnl">Unrealized P&amp;L</th>
                                    <th data-i18n="pnl_percent">P&amp;L %</th>
                                    <th data-i18n="stop_loss">Stop Loss</th>
                                    <th data-i18n="take_profit">Take Profit</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">No active positions</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trades Section -->
                <div id="trades-section" class="content-section" style="display: none;">
                    <h2><i class="fas fa-exchange-alt"></i> <span data-i18n="trading_history">Trading History</span></h2>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th data-i18n="time">Time</th>
                                    <th data-i18n="symbol">Symbol</th>
                                    <th data-i18n="action">Action</th>
                                    <th data-i18n="quantity">Quantity</th>
                                    <th data-i18n="price">Price</th>
                                    <th data-i18n="fees">Fees</th>
                                    <th data-i18n="strategy">Strategy</th>
                                    <th data-i18n="status">Status</th>
                                </tr>
                            </thead>
                            <tbody id="trades-table">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">No trades found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Strategies Section -->
                <div id="strategies-section" class="content-section" style="display: none;">
                    <h2><i class="fas fa-cogs"></i> <span data-i18n="trading_strategies">Trading Strategies</span></h2>
                    <div id="strategies-list">
                        <p class="text-muted">Loading strategies...</p>
                    </div>
                </div>

                <!-- Risk Management Section -->
                <div id="risk-section" class="content-section" style="display: none;">
                    <h2><i class="fas fa-shield-alt"></i> <span data-i18n="risk_management">Risk Management</span></h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5 data-i18n="risk_limits">Risk Limits</h5>
                                <div id="risk-limits">
                                    <p class="text-muted">Loading risk limits...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5 data-i18n="daily_metrics">Daily Metrics</h5>
                                <div id="daily-risk-metrics">
                                    <p class="text-muted">Loading daily metrics...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Market Data Section -->
                <div id="market-section" class="content-section" style="display: none;">
                    <h2><i class="fas fa-chart-bar"></i> <span data-i18n="market_data">Coin Market Data</span></h2>
                    <div class="row">
                        <div class="col-12">
                            <div class="metric-card">
                                <h5 data-i18n="current_market_prices">Current Market Prices</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th data-i18n="symbol">Symbol</th>
                                                <th data-i18n="price">Price</th>
                                                <th data-i18n="change">Change</th>
                                                <th data-i18n="change_percent">Change %</th>
                                                <th data-i18n="volume">Volume</th>
                                                <th data-i18n="market_cap">Market Cap</th>
                                            </tr>
                                        </thead>
                                        <tbody id="market-data-table">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">Loading market data...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backtest Section -->
                <div id="backtest-section" class="content-section" style="display: none;">
                    <h2><i class="fas fa-flask"></i> <span data-i18n="backtest">Backtest</span></h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5 data-i18n="run_backtest">Run Backtest</h5>
                                <form id="backtest-form">
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="bt_symbols">Symbols (comma-separated)</label>
                                        <input type="text" class="form-control" id="backtest-symbols" value="BTC-USD,ETH-USD,SOL-USD">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="bt_days">Days</label>
                                        <input type="number" class="form-control" id="backtest-days" value="180" min="30" max="365">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="bt_initial_capital">Initial Capital</label>
                                        <input type="number" class="form-control" id="backtest-capital" value="10000" min="100">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="bt_strategies">Strategies</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="momentum" id="bt-strategy-momentum" checked>
                                            <label class="form-check-label" for="bt-strategy-momentum" data-i18n="strategy_momentum">Momentum</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="mean_reversion" id="bt-strategy-mean" checked>
                                            <label class="form-check-label" for="bt-strategy-mean" data-i18n="strategy_mean_reversion">Mean Reversion</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="technical_analysis" id="bt-strategy-tech" checked>
                                            <label class="form-check-label" for="bt-strategy-tech" data-i18n="strategy_technical">Technical Analysis</label>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary" data-i18n="run_backtest_button">Run Backtest</button>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5 data-i18n="results">Results</h5>
                                <div id="backtest-results" class="text-muted">Run a backtest to see results.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="content-section" style="display: none;">
                    <h2><i class="fas fa-cog"></i> <span data-i18n="settings">Settings</span></h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5 data-i18n="trading_configuration">Trading Configuration</h5>
                                <form id="trading-config-form">
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="max_position_size">Max Position Size (%)</label>
                                        <input type="number" class="form-control" id="max-position-size" value="10" min="1" max="100">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="stop_loss_percent">Stop Loss (%)</label>
                                        <input type="number" class="form-control" id="stop-loss" value="5" min="1" max="50">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="take_profit_percent">Take Profit (%)</label>
                                        <input type="number" class="form-control" id="take-profit" value="15" min="1" max="100">
                                    </div>
                                    <button type="submit" class="btn btn-primary" data-i18n="save_settings">Save Settings</button>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h5 data-i18n="notification_settings">Notification Settings</h5>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                                    <label class="form-check-label" for="email-notifications" data-i18n="email_notifications">
                                        Email Notifications
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="trade-notifications" checked>
                                    <label class="form-check-label" for="trade-notifications" data-i18n="trade_notifications">
                                        Trade Notifications
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="risk-alerts" checked>
                                    <label class="form-check-label" for="risk-alerts" data-i18n="risk_alerts">
                                        Risk Alerts
                                    </label>
                                </div>
                                <hr>
                                <label class="form-label mt-2" data-i18n="api_key_label">API Key</label>
                                <input type="password" class="form-control mb-2" id="api-key-input">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="save-api-key" data-i18n="save_api_key">Save API Key</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let portfolioChart, positionChart;
        let refreshInterval;
        let currentLanguage = 'en';
        const API_KEY_STORAGE_KEY = 'qf_api_key';

        const translations = {
            en: {
                app_title: 'QuantFlow Paper Trading',
                app_subtitle: 'Real-time monitoring and control of your automated trading system',
                sidebar_title: 'Trading Bot',
                nav_dashboard: 'Dashboard',
                nav_portfolio: 'Portfolio',
                nav_positions: 'Positions',
                nav_trades: 'Trades',
                nav_strategies: 'Strategies',
                nav_backtest: 'Backtest',
                nav_risk: 'Risk Management',
                nav_market: 'Market Data',
                nav_settings: 'Settings',
                trading_status: 'Trading Status',
                portfolio_value: 'Portfolio Value',
                total_pnl: 'Total P&L',
                active_positions: 'Active Positions',
                recent_events: 'Recent Signals & Events',
                time: 'Time',
                type: 'Type',
                symbol: 'Symbol',
                strategy: 'Strategy',
                message: 'Message',
                start_trading: 'Start Trading',
                stop_trading: 'Stop Trading',
                refresh_data: 'Refresh Data',
                test_alert: 'Test Alert',
                portfolio_performance: 'Portfolio Performance',
                position_distribution: 'Position Distribution',
                recent_trades: 'Recent Trades',
                action: 'Action',
                quantity: 'Quantity',
                price: 'Price',
                status: 'Status',
                portfolio_overview: 'Portfolio Overview',
                performance_metrics: 'Performance Metrics',
                risk_metrics: 'Risk Metrics',
                active_positions_title: 'Active Positions',
                avg_price: 'Avg Price',
                current_price: 'Current Price',
                unrealized_pnl: 'Unrealized P&L',
                pnl_percent: 'P&L %',
                stop_loss: 'Stop Loss',
                take_profit: 'Take Profit',
                trading_history: 'Trading History',
                fees: 'Fees',
                trading_strategies: 'Trading Strategies',
                risk_management: 'Risk Management',
                risk_limits: 'Risk Limits',
                daily_metrics: 'Daily Metrics',
                market_data: 'Coin Market Data',
                current_market_prices: 'Current Market Prices',
                change: 'Change',
                change_percent: 'Change %',
                volume: 'Volume',
                market_cap: 'Market Cap',
                backtest: 'Backtest',
                run_backtest: 'Run Backtest',
                bt_symbols: 'Symbols (comma-separated)',
                bt_days: 'Days',
                bt_initial_capital: 'Initial Capital',
                bt_strategies: 'Strategies',
                strategy_momentum: 'Momentum',
                strategy_mean_reversion: 'Mean Reversion',
                strategy_technical: 'Technical Analysis',
                run_backtest_button: 'Run Backtest',
                results: 'Results',
                settings: 'Settings',
                trading_configuration: 'Trading Configuration',
                max_position_size: 'Max Position Size (%)',
                stop_loss_percent: 'Stop Loss (%)',
                take_profit_percent: 'Take Profit (%)',
                save_settings: 'Save Settings',
                notification_settings: 'Notification Settings',
                email_notifications: 'Email Notifications',
                trade_notifications: 'Trade Notifications',
                risk_alerts: 'Risk Alerts',
                api_key_label: 'API Key',
                save_api_key: 'Save API Key'
            },
            sq: {
                app_title: 'QuantFlow Tregtim në Letër',
                app_subtitle: 'Monitorim dhe kontroll në kohë reale të sistemit të trade-it automatik',
                sidebar_title: 'Trading Robot',
                nav_dashboard: 'Paneli',
                nav_portfolio: 'Portofoli',
                nav_positions: 'Pozicionet',
                nav_trades: 'Tregtimet',
                nav_strategies: 'Strategjitë',
                nav_backtest: 'Simulim backtest',
                nav_risk: 'Menaxhim Rreziku',
                nav_market: 'Të Dhëna Tregu',
                nav_settings: 'Cilësimet',
                trading_status: 'Statusi i Trade-it',
                portfolio_value: 'Vlera e Portofolit',
                total_pnl: 'Fitim/Humbje Totale',
                active_positions: 'Pozicione Aktive',
                recent_events: 'Sinjale & Ngjarje të Fundit',
                time: 'Koha',
                type: 'Lloji',
                symbol: 'Simboli',
                strategy: 'Strategjia',
                message: 'Mesazhi',
                start_trading: 'Fillo Tregtimin',
                stop_trading: 'Ndal Tregtimin',
                refresh_data: 'Rifresko të Dhënat',
                test_alert: 'Testo Njoftim',
                portfolio_performance: 'Performanca e Portofolit',
                position_distribution: 'Shpërndarja e Pozicioneve',
                recent_trades: 'Tregtimet e Fundit',
                action: 'Veprimi',
                quantity: 'Sasia',
                price: 'Çmimi',
                status: 'Statusi',
                portfolio_overview: 'Përmbledhje e Portofolit',
                performance_metrics: 'Metrika të Performancës',
                risk_metrics: 'Metrika të Rrezikut',
                active_positions_title: 'Pozicione Aktive',
                avg_price: 'Çmimi Mesatar',
                current_price: 'Çmimi Aktual',
                unrealized_pnl: 'Fitim/Humbje e Parealizuar',
                pnl_percent: '% Fitim/Humbje',
                stop_loss: 'Ndalim Humbjeje',
                take_profit: 'Marrje Fitimi',
                trading_history: 'Historia e Tregtimit',
                fees: 'Tarifa',
                trading_strategies: 'Strategji Tregtimi',
                risk_management: 'Menaxhim Rreziku',
                risk_limits: 'Kufijtë e Rrezikut',
                daily_metrics: 'Metrika Ditore',
                market_data: 'Të Dhëna të Tregut të Monedhave',
                current_market_prices: 'Çmime Aktualë të Tregut',
                change: 'Ndryshimi',
                change_percent: '% Ndryshimi',
                volume: 'Vëllimi',
                market_cap: 'Kapitalizimi',
                backtest: 'Testim i prapambetur',
                run_backtest: 'Kryej Testim',
                bt_symbols: 'Simbole (të ndara me presje)',
                bt_days: 'Ditë',
                bt_initial_capital: 'Kapitali Fillestar',
                bt_strategies: 'Strategjitë',
                strategy_momentum: 'Momentum',
                strategy_mean_reversion: 'Kthim te Mesatarja',
                strategy_technical: 'Analizë Teknike',
                run_backtest_button: 'Kryej Testim',
                results: 'Rezultate',
                settings: 'Cilësimet',
                trading_configuration: 'Konfigurimi i Tregtimit',
                max_position_size: 'Madhësia Maks e Pozicionit (%)',
                stop_loss_percent: 'Ndalim Humbjeje (%)',
                take_profit_percent: 'Marrje Fitimi (%)',
                save_settings: 'Ruaj Cilësimet',
                notification_settings: 'Cilësimet e Njoftimeve',
                email_notifications: 'Njoftime me Email',
                trade_notifications: 'Njoftime për Tregtime',
                risk_alerts: 'Njoftime Rreziku',
                api_key_label: 'Çelësi API',
                save_api_key: 'Ruaj Çelësin API'
            }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            initializeLanguage();
            initializeTooltips();
            initializeApiKeySettings();
            refreshData();
            startAutoRefresh();

            const backtestForm = document.getElementById('backtest-form');
            if (backtestForm) {
                backtestForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    runBacktest();
                });
            }

            const tradingConfigForm = document.getElementById('trading-config-form');
            if (tradingConfigForm) {
                tradingConfigForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    saveTradingSettings();
                });
            }

            loadTradingSettings();
        });

        async function apiFetch(url, options = {}) {
            const headers = Object.assign({}, options.headers || {});
            const apiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (apiKey) {
                headers['X-API-Key'] = apiKey;
            }

            const response = await fetch(url, Object.assign({}, options, { headers }));
            if (!response.ok) {
                let message = `HTTP ${response.status}`;
                try {
                    const payload = await response.json();
                    if (payload && payload.detail) {
                        message = payload.detail;
                    }
                } catch (error) {
                    // Ignore parsing errors and keep HTTP fallback message.
                }
                throw new Error(message);
            }
            return response;
        }

        function initializeApiKeySettings() {
            const input = document.getElementById('api-key-input');
            const button = document.getElementById('save-api-key');
            if (!input || !button) return;

            const existing = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (existing) {
                input.value = existing;
            }

            button.addEventListener('click', function() {
                const value = input.value.trim();
                if (!value) {
                    localStorage.removeItem(API_KEY_STORAGE_KEY);
                    showAlert('API key removed from browser storage.', 'warning');
                    return;
                }
                localStorage.setItem(API_KEY_STORAGE_KEY, value);
                showAlert('API key saved. Refreshing dashboard data...', 'success');
                refreshData();
            });
        }

        // Initialize charts
        function initializeCharts() {
            // Portfolio performance chart
            const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
            portfolioChart = new Chart(portfolioCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });

            // Position distribution chart
            const positionCtx = document.getElementById('positionChart').getContext('2d');
            positionChart = new Chart(positionCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function initializeLanguage() {
            const select = document.getElementById('language-select');
            if (!select) return;
            select.addEventListener('change', () => {
                setLanguage(select.value);
            });
            setLanguage(select.value || 'en');
        }

        function setLanguage(lang) {
            currentLanguage = translations[lang] ? lang : 'en';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = translations[currentLanguage][key];
                if (typeof value === 'string') {
                    el.textContent = value;
                }
            });
            updateDynamicStatusLabels();
        }

        function updateDynamicStatusLabels() {
            const statusElement = document.getElementById('trading-status');
            if (!statusElement) return;
            const isRunning = statusElement.textContent.toLowerCase().includes('running') ||
                statusElement.textContent.toLowerCase().includes('në punë');
            const runningText = currentLanguage === 'sq' ? 'Në punë' : 'Running';
            const stoppedText = currentLanguage === 'sq' ? 'Ndalur' : 'Stopped';
            const className = isRunning ? 'status-indicator status-running' : 'status-indicator status-stopped';
            statusElement.innerHTML = `<span class="${className}"></span>${isRunning ? runningText : stoppedText}`;
        }

        function initializeTooltips() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Show section
        function showSection(sectionName, navLink) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';

            // Add active class to clicked nav link
            if (navLink) {
                navLink.classList.add('active');
            }

            // Load section data
            loadSectionData(sectionName);
        }

        // Load section data
        function loadSectionData(sectionName) {
            switch(sectionName) {
                case 'dashboard':
                    refreshData();
                    break;
                case 'portfolio':
                    loadPortfolioData();
                    break;
                case 'positions':
                    loadPositionsData();
                    break;
                case 'trades':
                    loadTradesData();
                    break;
                case 'strategies':
                    loadStrategiesData();
                    break;
                case 'risk':
                    loadRiskData();
                    break;
                case 'market':
                    loadMarketData();
                    break;
                case 'backtest':
                    break;
                case 'settings':
                    loadTradingSettings();
                    break;
            }
        }

        // Refresh all data
        async function refreshData() {
            try {
                await Promise.all([
                    loadTradingStatus(),
                    loadPortfolioOverview(),
                    loadPortfolioPerformance(),
                    loadPositionDistribution(),
                    loadRecentTrades(),
                    loadMarketData(),
                    loadEvents()
                ]);
            } catch (error) {
                console.error('Error refreshing data:', error);
                showAlert('Error refreshing data: ' + error.message, 'danger');
            }
        }

        // Load trading status
        async function loadTradingStatus() {
            try {
                const response = await apiFetch('/api/v1/trading/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('trading-status');
                const indicator = statusElement.querySelector('.status-indicator');
                
                if (data.is_running) {
                    indicator.className = 'status-indicator status-running';
                    const runningText = currentLanguage === 'sq' ? 'Në punë' : 'Running';
                    statusElement.innerHTML = `<span class="status-indicator status-running"></span>${runningText}`;
                } else {
                    indicator.className = 'status-indicator status-stopped';
                    const stoppedText = currentLanguage === 'sq' ? 'Ndalur' : 'Stopped';
                    statusElement.innerHTML = `<span class="status-indicator status-stopped"></span>${stoppedText}`;
                }

                const venueChip = document.getElementById('venue-chip');
                if (venueChip) {
                    if (data.okx_enabled) {
                        venueChip.className = `badge ${data.okx_demo ? 'bg-info' : 'bg-success'} fs-6 px-3 py-2`;
                        venueChip.textContent = data.okx_demo ? 'OKX Demo' : 'OKX Live';
                    } else {
                        venueChip.className = 'badge bg-secondary fs-6 px-3 py-2';
                        venueChip.textContent = 'Market Data: Yahoo';
                    }
                }
            } catch (error) {
                console.error('Error loading trading status:', error);
            }
        }

        async function loadEvents() {
            try {
                const response = await apiFetch('/api/v1/trading/events');
                const data = await response.json();
                const events = data.events || [];
                const tbody = document.getElementById('events-table');
                const count = document.getElementById('events-count');
                count.textContent = `${events.length} events`;
                if (events.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">No events yet</td></tr>';
                    return;
                }
                tbody.innerHTML = events.map(ev => `
                    <tr>
                        <td>${new Date(ev.timestamp).toLocaleTimeString()}</td>
                        <td>${ev.type}</td>
                        <td>${ev.symbol}</td>
                        <td>${ev.strategy || ''}</td>
                        <td>${ev.message}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        // Load portfolio overview
        async function loadPortfolioOverview() {
            try {
                const response = await apiFetch('/api/v1/portfolio/overview');
                const data = await response.json();
                
                const metrics = data.portfolio_metrics;
                
                document.getElementById('portfolio-value').textContent = 
                    '$' + metrics.total_value.toLocaleString('en-US', {minimumFractionDigits: 2});
                
                const totalPnl = metrics.total_pnl || 0;
                const pnlElement = document.getElementById('total-pnl');
                pnlElement.textContent = '$' + totalPnl.toLocaleString('en-US', {minimumFractionDigits: 2});
                pnlElement.className = 'metric-value ' + (totalPnl >= 0 ? 'positive' : 'negative');
                
                document.getElementById('active-positions').textContent = metrics.num_positions || 0;
                
            } catch (error) {
                console.error('Error loading portfolio overview:', error);
            }
        }

        // Load portfolio performance chart
        async function loadPortfolioPerformance() {
            try {
                const response = await apiFetch('/api/v1/portfolio/performance?limit=120');
                const data = await response.json();
                const performance = data.performance || [];

                if (performance.length === 0) {
                    portfolioChart.data.labels = [];
                    portfolioChart.data.datasets[0].data = [];
                    portfolioChart.update();
                    return;
                }

                const labels = performance.map(point => {
                    if (!point.timestamp) return '';
                    const ts = new Date(point.timestamp);
                    return ts.toLocaleString();
                });
                const values = performance.map(point => point.total_value);

                portfolioChart.data.labels = labels;
                portfolioChart.data.datasets[0].data = values;
                portfolioChart.update();
            } catch (error) {
                console.error('Error loading portfolio performance:', error);
            }
        }

        // Load position distribution chart
        async function loadPositionDistribution() {
            try {
                const response = await apiFetch('/api/v1/portfolio/positions');
                const data = await response.json();
                const positions = data.positions || [];

                if (positions.length === 0) {
                    positionChart.data.labels = [];
                    positionChart.data.datasets[0].data = [];
                    positionChart.update();
                    return;
                }

                const labels = positions.map(pos => pos.symbol);
                const values = positions.map(pos => (pos.quantity * pos.current_price));

                positionChart.data.labels = labels;
                positionChart.data.datasets[0].data = values;
                positionChart.update();
            } catch (error) {
                console.error('Error loading position distribution:', error);
            }
        }

        // Load recent trades
        async function loadRecentTrades() {
            try {
                const response = await apiFetch('/api/v1/portfolio/trades?limit=10');
                const data = await response.json();
                
                const tbody = document.getElementById('recent-trades');
                
                if (data.trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No recent trades</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.trades.map(trade => `
                    <tr>
                        <td>${new Date(trade.timestamp).toLocaleString()}</td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td><span class="badge ${trade.side === 'BUY' ? 'bg-success' : 'bg-danger'}">${trade.side}</span></td>
                        <td>${trade.quantity}</td>
                        <td>$${trade.price.toFixed(2)}</td>
                        <td>${trade.strategy}</td>
                        <td><span class="badge bg-success">${trade.status}</span></td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading recent trades:', error);
            }
        }

        // Load market data
        async function loadMarketData() {
            try {
                const response = await apiFetch('/api/v1/market/data');
                const data = await response.json();
                
                const tbody = document.getElementById('market-data-table');
                
                if (!data.market_data || Object.keys(data.market_data).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No market data available</td></tr>';
                    return;
                }
                
                tbody.innerHTML = Object.values(data.market_data).map(coin => `
                    <tr>
                        <td><strong>${coin.symbol}</strong></td>
                        <td>$${coin.price.toFixed(2)}</td>
                        <td class="${coin.change >= 0 ? 'positive' : 'negative'}">$${coin.change.toFixed(2)}</td>
                        <td class="${coin.change_percent >= 0 ? 'positive' : 'negative'}">${coin.change_percent.toFixed(2)}%</td>
                        <td>${coin.volume.toLocaleString()}</td>
                        <td>${coin.market_cap ? `$${(coin.market_cap / 1000000000).toFixed(1)}B` : 'N/A'}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading market data:', error);
            }
        }

        // Run backtest
        async function runBacktest() {
            try {
                const symbols = document.getElementById('backtest-symbols').value
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean);
                const days = parseInt(document.getElementById('backtest-days').value, 10);
                const initialCapital = parseFloat(document.getElementById('backtest-capital').value);
                const strategies = [];
                if (document.getElementById('bt-strategy-momentum').checked) strategies.push('momentum');
                if (document.getElementById('bt-strategy-mean').checked) strategies.push('mean_reversion');
                if (document.getElementById('bt-strategy-tech').checked) strategies.push('technical_analysis');

                const response = await apiFetch('/api/v1/backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbols,
                        days,
                        strategies,
                        initial_capital: initialCapital
                    })
                });
                const data = await response.json();

                const resultsDiv = document.getElementById('backtest-results');
                if (!data.backtest || !data.backtest.summary) {
                    resultsDiv.textContent = 'No results available.';
                    return;
                }

                const summary = data.backtest.summary.strategies || {};
                const rows = Object.entries(summary).map(([name, stats]) => `
                    <tr>
                        <td>${name}</td>
                        <td>${stats.avg_return_percent.toFixed(2)}%</td>
                        <td>${stats.avg_max_drawdown_percent.toFixed(2)}%</td>
                        <td>${stats.symbols_tested}</td>
                    </tr>
                `).join('');

                resultsDiv.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Strategy</th>
                                    <th>Avg Return</th>
                                    <th>Avg Drawdown</th>
                                    <th>Symbols</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error running backtest:', error);
                showAlert('Error running backtest: ' + error.message, 'danger');
            }
        }

        // Load portfolio data
        async function loadPortfolioData() {
            try {
                const response = await apiFetch('/api/v1/portfolio/overview');
                const data = await response.json();
                
                const metrics = data.portfolio_metrics;
                document.getElementById('portfolio-metrics').innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Total Value:</strong> $${metrics.total_value.toLocaleString()}</p>
                            <p><strong>Cash Balance:</strong> $${metrics.cash_balance.toLocaleString()}</p>
                            <p><strong>Invested Amount:</strong> $${metrics.invested_amount.toLocaleString()}</p>
                        </div>
                        <div class="col-6">
                            <p><strong>Total Return:</strong> <span class="${metrics.total_return_percent >= 0 ? 'positive' : 'negative'}">${metrics.total_return_percent.toFixed(2)}%</span></p>
                            <p><strong>Sharpe Ratio:</strong> ${metrics.sharpe_ratio.toFixed(2)}</p>
                            <p><strong>Max Drawdown:</strong> ${metrics.max_drawdown.toFixed(2)}%</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading portfolio data:', error);
            }
        }

        // Load positions data
        async function loadPositionsData() {
            try {
                const response = await apiFetch('/api/v1/portfolio/positions');
                const data = await response.json();
                
                const tbody = document.getElementById('positions-table');
                
                if (data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No active positions</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.positions.map(position => `
                    <tr>
                        <td><strong>${position.symbol}</strong></td>
                        <td>${position.quantity}</td>
                        <td>$${position.average_price.toFixed(2)}</td>
                        <td>$${position.current_price.toFixed(2)}</td>
                        <td class="${position.unrealized_pnl >= 0 ? 'positive' : 'negative'}">$${position.unrealized_pnl.toFixed(2)}</td>
                        <td class="${position.pnl_percentage >= 0 ? 'positive' : 'negative'}">${position.pnl_percentage.toFixed(2)}%</td>
                        <td>${position.stop_loss ? '$' + position.stop_loss.toFixed(2) : 'N/A'}</td>
                        <td>${position.take_profit ? '$' + position.take_profit.toFixed(2) : 'N/A'}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading positions data:', error);
            }
        }

        // Load trades data
        async function loadTradesData() {
            try {
                const response = await apiFetch('/api/v1/portfolio/trades?limit=50');
                const data = await response.json();
                
                const tbody = document.getElementById('trades-table');
                
                if (data.trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No trades found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.trades.map(trade => `
                    <tr>
                        <td>${new Date(trade.timestamp).toLocaleString()}</td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td><span class="badge ${trade.side === 'BUY' ? 'bg-success' : 'bg-danger'}">${trade.side}</span></td>
                        <td>${trade.quantity}</td>
                        <td>$${trade.price.toFixed(2)}</td>
                        <td>$${trade.fees.toFixed(2)}</td>
                        <td>${trade.strategy}</td>
                        <td><span class="badge bg-success">${trade.status}</span></td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading trades data:', error);
            }
        }

        // Load strategies data
        async function loadStrategiesData() {
            try {
                const response = await apiFetch('/api/v1/strategies');
                const data = await response.json();
                
                const container = document.getElementById('strategies-list');
                
                if (data.strategies.length === 0) {
                    container.innerHTML = '<p class="text-muted">No strategies available</p>';
                    return;
                }
                
                container.innerHTML = data.strategies.map(strategy => `
                    <div class="metric-card">
                        <h5>${strategy.name}</h5>
                        <p><strong>Class:</strong> ${strategy.class_name}</p>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Total Trades:</strong> ${strategy.performance.total_trades}</p>
                                <p><strong>Win Rate:</strong> ${(strategy.performance.win_rate * 100).toFixed(1)}%</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total P&L:</strong> <span class="${strategy.performance.total_pnl >= 0 ? 'positive' : 'negative'}">$${strategy.performance.total_pnl.toFixed(2)}</span></p>
                                <p><strong>Sharpe Ratio:</strong> ${strategy.performance.sharpe_ratio.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading strategies data:', error);
            }
        }

        // Load risk data
        async function loadRiskData() {
            try {
                const response = await apiFetch('/api/v1/risk/metrics');
                const data = await response.json();
                
                const metrics = data.risk_metrics;
                
                document.getElementById('risk-limits').innerHTML = `
                    <p><strong>Max Position Size:</strong> ${(metrics.max_position_size * 100).toFixed(1)}%</p>
                    <p><strong>Max Portfolio Risk:</strong> ${(metrics.max_portfolio_risk * 100).toFixed(1)}%</p>
                    <p><strong>Max Daily Loss:</strong> ${(metrics.max_daily_loss * 100).toFixed(1)}%</p>
                    <p><strong>Max Daily Trades:</strong> ${metrics.max_daily_trades}</p>
                `;
                
                document.getElementById('daily-risk-metrics').innerHTML = `
                    <p><strong>Daily Trades:</strong> ${metrics.daily_trades}</p>
                    <p><strong>Daily P&L:</strong> <span class="${metrics.daily_pnl >= 0 ? 'positive' : 'negative'}">$${metrics.daily_pnl.toFixed(2)}</span></p>
                    <p><strong>Last Reset:</strong> ${new Date(metrics.last_reset_date).toLocaleDateString()}</p>
                `;
                
            } catch (error) {
                console.error('Error loading risk data:', error);
            }
        }

        async function loadTradingSettings() {
            try {
                const response = await apiFetch('/api/v1/settings/trading');
                const data = await response.json();
                const cfg = data.settings || {};
                if (typeof cfg.max_position_size_percent === 'number') {
                    document.getElementById('max-position-size').value = cfg.max_position_size_percent;
                }
                if (typeof cfg.stop_loss_percent === 'number') {
                    document.getElementById('stop-loss').value = cfg.stop_loss_percent;
                }
                if (typeof cfg.take_profit_percent === 'number') {
                    document.getElementById('take-profit').value = cfg.take_profit_percent;
                }
            } catch (error) {
                console.error('Error loading trading settings:', error);
            }
        }

        async function saveTradingSettings() {
            try {
                const payload = {
                    max_position_size_percent: parseFloat(document.getElementById('max-position-size').value),
                    stop_loss_percent: parseFloat(document.getElementById('stop-loss').value),
                    take_profit_percent: parseFloat(document.getElementById('take-profit').value)
                };

                const response = await apiFetch('/api/v1/settings/trading', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                showAlert(data.message || 'Settings updated successfully.', 'success');
                await loadTradingSettings();
                await loadRiskData();
            } catch (error) {
                console.error('Error saving trading settings:', error);
                showAlert('Error saving settings: ' + error.message, 'danger');
            }
        }

        // Trading controls
        async function startTrading() {
            try {
                const response = await apiFetch('/api/v1/trading/start', { method: 'POST' });
                const data = await response.json();
                
                showAlert(data.message, 'success');
                setTimeout(refreshData, 1000);
            } catch (error) {
                console.error('Error starting trading:', error);
                showAlert('Error starting trading: ' + error.message, 'danger');
            }
        }

        async function stopTrading() {
            try {
                const response = await apiFetch('/api/v1/trading/stop', { method: 'POST' });
                const data = await response.json();
                
                showAlert(data.message, 'success');
                setTimeout(refreshData, 1000);
            } catch (error) {
                console.error('Error stopping trading:', error);
                showAlert('Error stopping trading: ' + error.message, 'danger');
            }
        }

        async function testNotification() {
            try {
                const response = await apiFetch('/api/v1/notifications/test', { method: 'POST' });
                const data = await response.json();
                
                showAlert(data.message, 'info');
            } catch (error) {
                console.error('Error testing notification:', error);
                showAlert('Error testing notification: ' + error.message, 'danger');
            }
        }

        // Auto refresh
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 30000); // Refresh every 30 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the content area
            const contentArea = document.querySelector('.content-area');
            contentArea.insertBefore(alertDiv, contentArea.firstChild);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
